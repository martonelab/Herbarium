---
title: "Submitting Data to the Herbarium"
author: "Jasmine"
date: '2019-04-29'
output: html_document
---

specify some variables:
1. what the output file will be named
```{r}
file <- "Cbodegensis"
```

List of specimens you want
```{r}
want <- c("PTM1986")
```

Make sure you have these packages installed
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(googlesheets)
library(here)
library(taxize)
library(googlesheets4)
```

## Read in the master list
- you will need to verify
```{r, warning=FALSE}
gs_ptm <- read_sheet("https://docs.google.com/spreadsheets/d/1vzVIT5gjQ0yCGwbAyqB4f8pltOkLfWz27TIFTxnm9hk",
                     sheet = 1,skip = 1, col_types = "iccccccDcccccccccccDcccccccnnccccc-")
```

## Select the rows
```{r}
df <- gs_ptm %>% 
  mutate(num = paste0("PTM",`PTM#`)) %>% 
  filter(num %in% want)
```

### Figure out which name to use
```{r}
df_nm <- df %>% 
  mutate(choice = if_else(is.na(df$`Final determination`),
                      df$`Determination in the field`,
                      df$`Final determination`),
         gs = choice) %>% 
  separate(choice, c("Genus","Species"), " ")

# check
names <- cbind(df$`Final determination`, df$`Determination in the field`, df$`genetic match/notes`)
```

### Phylum Class Family
- !!! fix species
- BOLD is pretty reliable but still has mistakes on some obscure species
- only run if there isn't any phylum data
- can we use the herbarium data base?

!!! need to see if you can get authorship

```{r}
collector_a <- read_xlsx("Master-Collector-Excel-Templates-20190429.xlsx",sheet = 2, skip = 4)
```

```{r}
higher <- classification(df_nm$Genus, db= "bold")

sa <- itis_terms(df_nm$gs) %>% 
  separate(author, into = c("authorship", "year"))

empty <- collector_a[FALSE,]

for(i in 1:length(higher)) {
  if(!is.na(higher[i])) {
    species <- higher[[i]]
    rect <- c(species$name)
    names(rect) <- c(species$rank)

    empty <- empty %>%
      add_row(Phylum = rect["phylum"],
              Class = rect["class"],
              Genus = rect["genus"])
  }
  else{empty <- empty %>%  add_row(Phylum = NA)}
}
```

```{r}
meta <- df_nm %>%
  mutate(Herbarium = "UBC",
         LabelQty = 1,
         Qualifier = "",
         Country = Country,
         ProvinceState = StateProvince,
         Coralline = "Yes",
         Location = Locality,
         `Collector Number` = paste0("PTM",`PTM#`),
         ProjectID = file) %>% 
  cbind(Phylum = empty$Phylum, Class = empty$Class, `Species Author` = sa$authorship)


final <- meta %>% 
  select( Herbarium, LabelQty, Phylum, Class, Genus, Qualifier, Species, `Species Author`,
          Country, ProvinceState, Location,Latitude, Longitude, Habitat, Depth, `Reproductive Status`, `Date Collected`, `Primary Collector`,`Other collectors`, `Collector Number`, `Determined by`, `Determination Date`, `Field Notes`, Coralline)

```

```{r}
write_csv(final,paste0("output/",file,".csv"), na = "")
```
